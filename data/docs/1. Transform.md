---
title: "Преобразование исходных данных"
author: "Евгений Бердинских, Марина Козырева, Антон Тихоненко, Олеся Цветкова"
date: "2024-12-16"
output: 
  html_document:
    keep_md: true
---



## Загрузка исходных файлов 


``` r
# Данные по вызовам скорой помощи по поводу острого нарушения мозгового кровообращения в Иркутске (2006 - 2022 года)
brain_data_raw <- read_excel("data/raw/database_2024-11-09.xlsx")  

# Индексы геомагнитной активности (Ap) из GFZ, Potsdam (2006 - 2022 года)
GFZ_Potsdam_Ap <- read_csv("data/raw/GFZ_Potsdam.csv")  

# Индексы геомагнитной активности (Dst) из WDC, Kyoto (2006 - 2022 года)
WDC_Kyoto_Dst <- read_fwf("data/raw/WDC_Kyoto.dat", fwf_widths(c(3, 2, 2, 1, 2, 2, 1, 1, 2, 4, rep(4, 24), 4))) %>%
  rowwise() %>%
  transmute(
    Date = as.Date(paste0(X9, X2, "-", X3, "-", X5)),
    Dst_mean = X35,  #Среднее значение Dst за сутки
    Dst_max = max(c_across(X11:X34), na.rm = TRUE), #Максимальное значение Dst за сутки
    Dst_min = min(c_across(X11:X34), na.rm = TRUE), #Минимальное значение Dst за сутки
    across(X11:X34) %>%  set_names(paste0("H_", seq(1, 24))) #Индекс Dst на каждый час
  ) %>% 
  ungroup()

# Данные о событиях SSC (Внезапное начало бури) и SI (Внезапный импульс) из Observatori de l'Ebre (2006 - 2022 года)
Obs_Ebre_SSC <- tibble()

for (i in (2006:2022)) {
  
  link <- paste0("data/raw/SC_data/ssc_", i, "_d.txt")
  
  Obs_Ebre_SSC %>% rbind(
    read_tsv(link, col_names = "raw") %>%
      filter(str_starts(raw, paste0(i))) %>%
      transmute(
        Date = str_replace_all(str_trunc( raw, width = 10, ellipsis = ""), " ", "-") %>% as.Date(),
        Storm = factor(str_remove_all(raw, "-") %>% str_trunc( width = 2, side = "left", ellipsis = "" ),
          levels = c("SI", "SC"),
          labels = c("Sud_Imp", "Sud_Storm")
        ))) -> Obs_Ebre_SSC

  }

Obs_Ebre_SSC <- Obs_Ebre_SSC %>%
  count(Date, Storm) %>%
  pivot_wider(names_from = Storm, values_from = n)


# Погода в Иркутске из Росгидромет (1882 - 2023 года)
Roshydromet_Irkutsk <- read_fwf("data/raw/Roshydromet_Irkutsk.dat", fwf_widths(c(
  5, 1, 4, 1, 2, 1, 2, 1, 1, 1, 5, 1, 1, 1, 5, 1, 1, 1, 5, 1, 1, 1, 5, 1, 1, 1
))) %>%
  select(where(is.numeric)) %>%
  transmute(
    Date = as.Date(paste0(X3, "-", X5, "-", X7)),
    Temp_mean = X15,  # Температура за день (средняя, минимум, максиум)
    Temp_min = X11,
    Temp_max = X19,
    H2O = X23 # Количество осадков за день
  ) 

#Международное число солнечных пятен из SIDC, Brussels (1818 - 2024 года)
SIDC_SILSO <- read_delim("data/raw/SIDC_SILSO.csv", delim = ";", col_names = FALSE)  %>% 
  transmute(Date = as.Date(paste0(X1, "-", X2, "-", X3)), 
            Sunspots = as.numeric(X5))
```

## Оценка исходных данных


``` r
skim(brain_data_raw)
```


Table: Data summary

|                         |               |
|:------------------------|:--------------|
|Name                     |brain_data_raw |
|Number of rows           |5738           |
|Number of columns        |50             |
|_______________________  |               |
|Column type frequency:   |               |
|character                |1              |
|logical                  |1              |
|numeric                  |48             |
|________________________ |               |
|Group variables          |None           |


**Variable type: character**

|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|
|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|
|Дата          |         1|             1|  10|  10|     0|     5737|          0|


**Variable type: logical**

|skim_variable              | n_missing| complete_rate| mean|count               |
|:--------------------------|---------:|-------------:|----:|:-------------------|
|Количество умерших в сутки |      4417|          0.23| 0.16|FAL: 1105, TRU: 216 |


**Variable type: numeric**

|skim_variable                                                                            | n_missing| complete_rate|    mean|     sd|       p0|    p25|     p50|     p75|    p100|hist  |
|:----------------------------------------------------------------------------------------|---------:|-------------:|-------:|------:|--------:|------:|-------:|-------:|-------:|:-----|
|Вызов СМП с диагнозом ОНМК у всех пациентов старше 25 лет                                |         1|          1.00|   12.57|   6.23|     0.00|    8.0|   12.00|   17.00|   40.00|▅▇▅▁▁ |
|Количество вызовов СМП с диагнозом ОНМК у мужчин 25-44 лет                               |         1|          1.00|    0.74|   0.97|     0.00|    0.0|    0.00|    1.00|    7.00|▇▁▁▁▁ |
|Количество вызовов СМП с диагнозом ОНМК у мужчин 45-54 лет                               |         1|          1.00|    0.80|   0.97|     0.00|    0.0|    1.00|    1.00|    9.00|▇▂▁▁▁ |
|Количество вызовов СМП с диагнозом ОНМК у мужчин старше 55 лет                           |         1|          1.00|    3.54|   2.44|     0.00|    2.0|    3.00|    5.00|   18.00|▇▆▁▁▁ |
|Количество вызовов СМП с диагнозом ОНМК у женщин 25-44 лет                               |         1|          1.00|    0.74|   0.97|     0.00|    0.0|    0.00|    1.00|    8.00|▇▂▁▁▁ |
|Количество вызовов СМП с диагнозом ОНМК у женщин 45-54 лет                               |         1|          1.00|    0.80|   0.98|     0.00|    0.0|    1.00|    1.00|    6.00|▇▂▁▁▁ |
|Количество вызовов СМП с диагнозом ОНМК у женщин старше 55 лет                           |         1|          1.00|    5.96|   3.43|     0.00|    3.0|    6.00|    8.00|   22.00|▇▇▃▁▁ |
|Sum Кр...9                                                                               |         1|          1.00|   12.16|   8.01|     0.00|    6.0|   11.00|   17.00|   49.00|▇▇▂▁▁ |
|Среднее значение Ар индекса...10                                                         |         1|          1.00|    7.75|   7.87|     0.00|    3.0|    5.00|   10.00|  108.00|▇▁▁▁▁ |
|Международное число солнечных пятен                                                      |         1|          1.00|   27.13|  29.62|     0.00|    0.0|   17.00|   45.00|  141.00|▇▂▂▁▁ |
|Среднесуточное значение Dst в нТл                                                        |      2801|          0.51|   -8.95|  12.04|   -69.00|  -15.0|   -7.00|   -1.00|   19.00|▁▁▂▇▂ |
|Суммарное Dst в сутки                                                                    |      2784|          0.51| -221.97| 306.72| -2444.00| -355.0| -170.00|  -15.00|  452.00|▁▁▁▇▇ |
|Cкорректированный (F10.7)                                                                |        11|          1.00|   92.62|  28.42|    63.40|   70.4|   79.50|  109.15|  255.00|▇▂▁▁▁ |
|Температура воздуха на высоте 2 метра над поверхностью земли в 8:00, С (Т)               |       929|          0.84|   -1.29|  13.84|   -38.40|  -12.3|    0.50|   11.00|   23.20|▁▅▆▇▇ |
|Температура воздуха на высоте 2 метра над поверхностью земли в 17:00, С (Т)              |       923|          0.84|    6.24|  14.92|   -32.00|   -6.1|    7.50|   19.35|   35.40|▂▆▆▇▅ |
|Дельта температуры 17:00-8:00, ΔT                                                        |       916|          0.84|    7.51|   4.98|   -25.60|    4.0|    7.50|   11.30|   28.40|▁▁▆▇▁ |
|Дельта температуры 8:00-17:00, ΔT                                                        |       916|          0.84|   -7.51|   4.98|   -28.40|  -11.3|   -7.50|   -4.00|   25.60|▁▇▆▁▁ |
|Температура воздуха на высоте 2 метра над поверхностью земли сумарно за весь день, С (Т) |       916|          0.84|    4.94|  28.32|   -67.60|  -18.4|    8.60|   30.00|   55.70|▁▆▆▇▆ |
|Температура воздуха на высоте 2 метра над поверхностью земли в среднем за сутки, С (Т)   |       916|          0.84|    2.47|  14.16|   -33.80|   -9.2|    4.30|   15.00|   27.85|▁▆▆▇▆ |
|Максимальная температура                                                                 |        19|          1.00|    7.43|  14.76|   -32.00|   -5.0|    9.00|   20.50|   35.60|▁▆▆▇▆ |
|Минимальная температура                                                                  |        18|          1.00|   -6.00|  14.01|   -42.00|  -18.0|   -3.00|    6.00|   18.80|▂▅▅▇▆ |
|Средняя температура                                                                      |        18|          1.00|    0.85|  14.10|   -36.80|  -10.9|    2.70|   13.40|   27.30|▁▆▆▇▆ |
|Скорость ветра                                                                           |        19|          1.00|    3.10|   1.43|     0.00|    2.0|    3.00|    4.00|   12.00|▇▇▂▁▁ |
|Количество осадков                                                                       |       426|          0.93|    1.18|   4.13|     0.00|    0.0|    0.00|    1.00|   80.00|▇▁▁▁▁ |
|Эффективная температура                                                                  |        18|          1.00|   -2.59|  15.40|   -42.10|  -15.5|   -1.20|   11.10|   26.80|▂▆▇▇▆ |
|Атмосферное давление на уровне станции в 8:00                                            |       928|          0.84|  721.81|  24.33|     0.00|  717.3|  721.80|  727.30|  749.60|▁▁▁▁▇ |
|Атмосферное давление на уровне станции в 17:00                                           |       928|          0.84|  721.55|   7.26|   701.90|  716.2|  720.90|  726.50|  747.60|▁▇▇▂▁ |
|Атмосферное давление сумарно за весь день, С (Т)                                         |       928|          0.84| 1443.36|  26.99|   717.30| 1433.6| 1442.55| 1453.60| 1496.80|▁▁▁▁▇ |
|Атмосферное давление в среднем за сутки, С (Т)                                           |       928|          0.84|  721.68|  13.49|   358.65|  716.8|  721.28|  726.80|  748.40|▁▁▁▁▇ |
|Kp 0-3                                                                                   |         0|          1.00|    1.67|   1.34|     0.00|    1.0|    2.00|    3.00|    8.00|▇▆▁▁▁ |
|Кр 3-6                                                                                   |         0|          1.00|    1.60|   1.33|     0.00|    1.0|    1.00|    2.00|    8.00|▇▆▁▁▁ |
|Кр 6-9                                                                                   |         0|          1.00|    1.39|   1.25|     0.00|    0.0|    1.00|    2.00|    8.00|▇▅▁▁▁ |
|Кр 9-12                                                                                  |         0|          1.00|    1.34|   1.17|     0.00|    1.0|    1.00|    2.00|    8.00|▇▃▁▁▁ |
|Кр 12-15                                                                                 |         0|          1.00|    1.47|   1.19|     0.00|    1.0|    1.00|    2.00|    8.00|▇▅▁▁▁ |
|Кр 15-18                                                                                 |         0|          1.00|    1.50|   1.23|     0.00|    1.0|    1.00|    2.00|    8.00|▇▅▁▁▁ |
|Кр 18-21                                                                                 |         0|          1.00|    1.55|   1.29|     0.00|    1.0|    1.00|    2.00|    8.00|▇▅▁▁▁ |
|Кр 21-24                                                                                 |         0|          1.00|    1.63|   1.31|     0.00|    1.0|    1.00|    2.00|    8.00|▇▆▁▁▁ |
|Sum Кр...40                                                                              |         0|          1.00|   12.24|   7.85|     0.00|    6.0|   11.00|   17.00|   49.00|▇▇▂▁▁ |
|Ар 0-3                                                                                   |         0|          1.00|    8.72|  11.39|     0.00|    3.0|    6.00|   12.00|  236.00|▇▁▁▁▁ |
|Ар 3-6                                                                                   |         0|          1.00|    8.34|  11.22|     0.00|    3.0|    5.00|    9.00|  179.00|▇▁▁▁▁ |
|Ар 6-9                                                                                   |         0|          1.00|    7.14|  10.58|     0.00|    2.0|    4.00|    7.00|  207.00|▇▁▁▁▁ |
|Ар 9-12                                                                                  |         0|          1.00|    6.63|   8.97|     0.00|    3.0|    4.00|    7.00|  179.00|▇▁▁▁▁ |
|Ар 12-15                                                                                 |         0|          1.00|    7.21|   9.56|     0.00|    3.0|    5.00|    7.00|  236.00|▇▁▁▁▁ |
|Ар 15-18                                                                                 |         0|          1.00|    7.54|   9.77|     0.00|    3.0|    5.00|    9.00|  179.00|▇▁▁▁▁ |
|Ар 18-21                                                                                 |         0|          1.00|    8.02|  10.71|     0.00|    3.0|    5.00|    9.00|  236.00|▇▁▁▁▁ |
|Ар 21-24                                                                                 |         0|          1.00|    8.44|  11.17|     0.00|    3.0|    5.00|    9.00|  179.00|▇▁▁▁▁ |
|Среднее значение Ар индекса...49                                                         |         0|          1.00|    7.75|   7.87|     0.00|    3.0|    5.00|   10.00|  108.00|▇▁▁▁▁ |
|Медленная магнитная буря-1 Внезапная магнитная буря-2                                    |      5278|          0.08|    1.16|   0.36|     1.00|    1.0|    1.00|    1.00|    2.00|▇▁▁▁▂ |


## Преобразование Dst индекса


``` r
#Метод главных компонент 
Dst_pca <- WDC_Kyoto_Dst %>% select(starts_with("H_")) %>% scale() %>% prcomp()
summary(Dst_pca)
```

```
## Importance of components:
##                           PC1    PC2    PC3    PC4     PC5     PC6     PC7     PC8     PC9    PC10    PC11
## Standard deviation     4.2766 1.6644 1.0932 0.7461 0.57604 0.45461 0.39727 0.34491 0.29912 0.25498 0.21681
## Proportion of Variance 0.7621 0.1154 0.0498 0.0232 0.01383 0.00861 0.00658 0.00496 0.00373 0.00271 0.00196
## Cumulative Proportion  0.7621 0.8775 0.9273 0.9505 0.96432 0.97293 0.97950 0.98446 0.98819 0.99090 0.99285
##                           PC12    PC13    PC14    PC15    PC16    PC17    PC18    PC19   PC20    PC21    PC22
## Standard deviation     0.18927 0.16376 0.14481 0.12753 0.11519 0.10486 0.09580 0.09169 0.0852 0.07985 0.07640
## Proportion of Variance 0.00149 0.00112 0.00087 0.00068 0.00055 0.00046 0.00038 0.00035 0.0003 0.00027 0.00024
## Cumulative Proportion  0.99435 0.99546 0.99634 0.99702 0.99757 0.99803 0.99841 0.99876 0.9991 0.99933 0.99957
##                           PC23    PC24
## Standard deviation     0.07300 0.07044
## Proportion of Variance 0.00022 0.00021
## Cumulative Proportion  0.99979 1.00000
```

``` r
fviz_eig(Dst_pca, addlabels = T, 
         xlab = "", ylab = "Процент дисперсии",
         main = "Объясненная дисперсия компонентов PCA")
```

![](data/pics/transform-Dst-1.png)<!-- -->

``` r
#Преобразование WDC_Kyoto_Dst
WDC_Kyoto_Dst <- WDC_Kyoto_Dst %>% 
  transmute(Date, Dst_mean,
            Dst_var = Dst_max - Dst_min, #Размах значений Dst за сутки
            Dst_level = factor(case_when(#Dst через факторную переменную
              Dst_min < -150 ~ "Severe", 
              Dst_min < -100 ~ "Major", 
              Dst_min < -50 ~ "Moderate",  
              Dst_min < -20 ~ "Weak",
              TRUE ~ "Quiet"), 
              levels = c("Quiet", "Weak", "Moderate", "Major", "Severe"), ordered = TRUE)
            ) %>% bind_cols( # Dst через главные компоненты
              as_tibble(Dst_pca$x) %>% select(PC1, PC2) %>% rename(Dst_PC1 = PC1, Dst_PC2 = PC2) )
```


## Подготовка файла для анализа


``` r
brain_data <- brain_data_raw %>% 
  transmute(
    Date = dmy(Дата), Month = as.factor(month(Date)), Year = as.factor(year(Date)), 
    EMS = `Вызов СМП с диагнозом ОНМК у всех пациентов старше 25 лет`, 
    #Разбивку по полу и возрастной группе рассмотрим позже:
    #EMS_male_1 = `Количество вызовов СМП с диагнозом ОНМК у мужчин 25-44 лет`, 
    #EMS_male_2 = `Количество вызовов СМП с диагнозом ОНМК у мужчин 45-54 лет`, 
    #EMS_male_3 = `Количество вызовов СМП с диагнозом ОНМК у мужчин старше 55 лет`, 
    #EMS_female_1 = `Количество вызовов СМП с диагнозом ОНМК у женщин 25-44 лет`, 
    #EMS_female_2 = `Количество вызовов СМП с диагнозом ОНМК у женщин 45-54 лет`, 
    #EMS_female_3 = `Количество вызовов СМП с диагнозом ОНМК у женщин старше 55 лет`, 
    
    #Пропуски в данных заменяем на среднее по соседним значениям:
    F10.7 = `Cкорректированный (F10.7)` %>% na.approx(na.rm = FALSE), 
    Wind = ifelse(is.na(`Скорость ветра`), na.approx(`Скорость ветра`, na.rm = FALSE), `Скорость ветра`), 
    Pressure = `Атмосферное давление в среднем за сутки, С (Т)` %>%  
      ifelse(. < 600, NA, .) %>% na.approx(na.rm = FALSE),
    
    #Данные о количестве умерших не используем из-за большого количества пропусков
  
  ) %>% 
  filter(!is.na(Date)) %>%
  left_join(Roshydromet_Irkutsk, by = join_by(Date)) %>%  #Данные о температуре и осадках
  left_join(SIDC_SILSO, by = join_by(Date)) %>%   #Данные о солнечных пятнах
  left_join(GFZ_Potsdam_Ap, by = join_by(Date)) %>%  #Данные о индексе Ap 
  left_join(WDC_Kyoto_Dst, by = join_by(Date)) %>%  #Данные о индексе Dst 
  left_join(Obs_Ebre_SSC, by = join_by(Date)) %>%  #Данные о магнитных бурях
  mutate( across( starts_with("Sud"), ~ factor( case_when(is.na(.) ~ "No",
                                                             TRUE ~ "Yes") ) ) )  
```


## Оценка преобразованного файла


``` r
skim(brain_data)
```


Table: Data summary

|                         |           |
|:------------------------|:----------|
|Name                     |brain_data |
|Number of rows           |5737       |
|Number of columns        |20         |
|_______________________  |           |
|Column type frequency:   |           |
|Date                     |1          |
|factor                   |5          |
|numeric                  |14         |
|________________________ |           |
|Group variables          |None       |


**Variable type: Date**

|skim_variable | n_missing| complete_rate|min        |max        |median     | n_unique|
|:-------------|---------:|-------------:|:----------|:----------|:----------|--------:|
|Date          |         0|             1|2006-11-30 |2022-08-14 |2014-10-07 |     5737|


**Variable type: factor**

|skim_variable | n_missing| complete_rate|ordered | n_unique|top_counts                              |
|:-------------|---------:|-------------:|:-------|--------:|:---------------------------------------|
|Month         |         0|             1|FALSE   |       12|1: 496, 3: 496, 5: 496, 7: 496          |
|Year          |         0|             1|FALSE   |       17|200: 366, 201: 366, 201: 366, 202: 366  |
|Dst_level     |         0|             1|TRUE    |        5|Qui: 3507, Wea: 1868, Mod: 325, Maj: 30 |
|Sud_Imp       |         0|             1|FALSE   |        2|No: 5667, Yes: 70                       |
|Sud_Storm     |         0|             1|FALSE   |        2|No: 5611, Yes: 126                      |


**Variable type: numeric**

|skim_variable | n_missing| complete_rate|   mean|    sd|      p0|    p25|    p50|    p75|   p100|hist  |
|:-------------|---------:|-------------:|------:|-----:|-------:|------:|------:|------:|------:|:-----|
|EMS           |         0|          1.00|  12.57|  6.23|    0.00|   8.00|  12.00|  17.00|  40.00|▅▇▅▁▁ |
|F10.7         |         0|          1.00|  92.61| 28.42|   63.40|  70.40|  79.50| 109.10| 255.00|▇▂▁▁▁ |
|Wind          |         0|          1.00|   3.10|  1.43|    0.00|   2.00|   3.00|   4.00|  12.00|▇▇▂▁▁ |
|Pressure      |       914|          0.84| 722.06|  7.04|  703.80| 716.80| 721.30| 726.85| 748.40|▁▇▆▂▁ |
|Temp_mean     |         0|          1.00|   1.69| 13.72|  -34.20|  -9.80|   3.50|  13.90|  25.80|▁▆▆▇▇ |
|Temp_min      |         0|          1.00|  -3.33| 13.14|  -38.60| -14.00|  -1.30|   8.00|  20.40|▁▅▆▇▆ |
|Temp_max      |         0|          1.00|   7.91| 14.65|  -30.40|  -4.70|   9.30|  21.10|  35.60|▁▆▆▇▆ |
|H2O           |         0|          1.00|   1.28|  4.33|    0.00|   0.00|   0.00|   0.70|  80.10|▇▁▁▁▁ |
|Sunspots      |         0|          1.00|  41.31| 44.75|    0.00|   0.00|  25.00|  68.00| 220.00|▇▂▂▁▁ |
|Ap_mean       |         0|          1.00|   7.75|  7.86|    0.00|   3.00|   5.00|  10.00| 108.00|▇▁▁▁▁ |
|Dst_mean      |         0|          1.00|  -9.90| 13.28| -127.00| -16.00|  -8.00|  -1.00|  21.00|▁▁▁▆▇ |
|Dst_var       |         0|          1.00|  20.99| 15.45|    4.00|  12.00|  17.00|  24.00| 279.00|▇▁▁▁▁ |
|Dst_PC1       |         0|          1.00|   0.00|  4.30|  -37.89|  -1.87|   0.78|   2.85|  10.22|▁▁▁▇▇ |
|Dst_PC2       |         0|          1.00|   0.00|  1.67|  -11.21|  -0.80|  -0.16|   0.54|  25.51|▁▇▁▁▁ |

## Запись/чтение преобразованного файла


``` r
#Локальное храненение данных 
write_csv(brain_data, "data/raw/brain_data.csv") 

#Загрузка данных для анализа
brain_data <- read_csv("data/raw/brain_data.csv") %>%
   mutate(across(c(Month, Year, Sud_Imp, Sud_Storm), as.factor),
          Dst_level = factor(Dst_level, 
                             levels = c("Quiet", "Weak", "Moderate", "Major", "Severe"),
                             ordered = TRUE))
```

