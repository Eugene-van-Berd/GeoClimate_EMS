---
title: "Регрессионный анализ"
author: "Евгений Бердинских, Марина Козырева, Антон Тихоненко, Олеся Цветкова"
date: "2024-12-16"
output: 
  html_document:
    keep_md: true
---



## Загрузка данных для анализа


``` r
brain_data <- read_csv("data/raw/brain_data.csv") %>%
   mutate(across(c(Month, Year, Sud_Imp, Sud_Storm), as.factor),
          Dst_level = factor(Dst_level, 
                             levels = c("Quiet", "Weak", "Moderate", "Major", "Severe"),
                             ordered = TRUE))
```


## Моделирование


``` r
model_poisson <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var,
                     data = brain_data, family = poisson)
summary(model_poisson)
```

```
## 
## Call:
## glm(formula = EMS ~ Date + Temp_mean + Sunspots + Dst_mean + 
##     Dst_var, family = poisson, data = brain_data)
## 
## Coefficients:
##               Estimate Std. Error z value Pr(>|z|)    
## (Intercept) -1.229e+00  4.107e-02 -29.917  < 2e-16 ***
## Date         2.253e-04  2.374e-06  94.899  < 2e-16 ***
## Temp_mean   -9.885e-04  2.730e-04  -3.621 0.000293 ***
## Sunspots     2.624e-04  8.653e-05   3.032 0.002428 ** 
## Dst_mean    -4.856e-04  3.158e-04  -1.538 0.124167    
## Dst_var     -2.682e-04  2.699e-04  -0.994 0.320379    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 18524.4  on 5736  degrees of freedom
## Residual deviance:  8996.3  on 5731  degrees of freedom
## AIC: 33271
## 
## Number of Fisher Scoring iterations: 4
```

``` r
dispersiontest(model_poisson)
```

```
## 
## 	Overdispersion test
## 
## data:  model_poisson
## z = 18.666, p-value < 2.2e-16
## alternative hypothesis: true dispersion is greater than 1
## sample estimates:
## dispersion 
##   1.544587
```

``` r
model_NBR <- glm.nb(EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var,
                    data = brain_data, link = "log")
summary(model_NBR)
```

```
## 
## Call:
## glm.nb(formula = EMS ~ Date + Temp_mean + Sunspots + Dst_mean + 
##     Dst_var, data = brain_data, link = "log", init.theta = 23.72861894)
## 
## Coefficients:
##               Estimate Std. Error z value Pr(>|z|)    
## (Intercept) -1.371e+00  5.008e-02 -27.374  < 2e-16 ***
## Date         2.333e-04  2.931e-06  79.593  < 2e-16 ***
## Temp_mean   -1.133e-03  3.423e-04  -3.308 0.000939 ***
## Sunspots     4.606e-04  1.071e-04   4.299 1.72e-05 ***
## Dst_mean    -3.932e-04  3.938e-04  -0.998 0.318060    
## Dst_var     -1.825e-04  3.375e-04  -0.541 0.588751    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for Negative Binomial(23.7286) family taken to be 1)
## 
##     Null deviance: 12463.1  on 5736  degrees of freedom
## Residual deviance:  6020.7  on 5731  degrees of freedom
## AIC: 32666
## 
## Number of Fisher Scoring iterations: 1
## 
## 
##               Theta:  23.73 
##           Std. Err.:  1.31 
## 
##  2 x log-likelihood:  -32651.99
```
## Параметры модели


``` r
#Пуассон
tidy(model_poisson, conf.level = 0.95, conf.int = TRUE) %>%
  mutate(
    model = "Poisson",  
    EMS_effect = ifelse(
    term != "(Intercept)",
    paste0(signif((exp(estimate) - 1) * 100, 3), "%"),
    signif((exp(estimate)), 3))) -> Poisson_data

#Пуассон с коррекцией гетероскедастичности
bind_cols(
  tidy(coeftest(model_poisson, vcov. = vcovHC(model_poisson, type = "HC3"))),
  coefci(model_poisson, vcov. = vcovHC(model_poisson, type = "HC3")) %>% 
    as_tibble() %>% rename(conf.low = "2.5 %", conf.high = "97.5 %")
  ) %>%
  mutate(
    model = "Poisson_vcovHC", 
    EMS_effect = ifelse(
    term != "(Intercept)",
    paste0(signif((exp(estimate) - 1) * 100, 3), "%"),
    signif((exp(estimate)), 3))) -> Poisson_vcovHC_data

#Пуассон с коррекцией гетероскедастичности и автокорреляции
residuals(model_poisson, type = "response") %>% acf()
```

![](data/pics/models-params-1.png)<!-- -->

``` r
bind_cols(
  tidy(coeftest(model_poisson, vcov. = vcovHAC(model_poisson))),
  coefci(model_poisson, vcov. = vcovHAC(model_poisson)) %>% 
    as_tibble() %>% rename(conf.low = "2.5 %", conf.high = "97.5 %")
) %>%
  mutate(
    model = "Poisson_vcovHAC", 
    EMS_effect = ifelse(
    term != "(Intercept)",
    paste0(signif((exp(estimate) - 1) * 100, 3), "%"),
    signif((exp(estimate)), 3))) -> Poisson_vcovHAC_data

#Отрицательное биномиальное распределение
tidy(model_NBR, conf.level = 0.95, conf.int = TRUE) %>% 
  # filter(p.value < 0.05) %>% 
  mutate(
    model = "Neg_binomial", 
    EMS_effect = ifelse(
    term != "(Intercept)",
    paste0(signif((exp(estimate) - 1) * 100, 3), "%"),
    signif((exp(estimate)), 3))) -> Neg_binomial_data


bind_rows(Poisson_data, Poisson_vcovHC_data, Poisson_vcovHAC_data, Neg_binomial_data) %>% 
  arrange(term)
```

```
## # A tibble: 24 × 9
##    term         estimate  std.error statistic   p.value  conf.low conf.high model           EMS_effect
##    <chr>           <dbl>      <dbl>     <dbl>     <dbl>     <dbl>     <dbl> <chr>           <chr>     
##  1 (Intercept) -1.23     0.0411        -29.9  1.18e-196 -1.31     -1.15     Poisson         0.293     
##  2 (Intercept) -1.23     0.0506        -24.3  2.85e-130 -1.33     -1.13     Poisson_vcovHC  0.293     
##  3 (Intercept) -1.23     0.0755        -16.3  1.74e- 59 -1.38     -1.08     Poisson_vcovHAC 0.293     
##  4 (Intercept) -1.37     0.0501        -27.4  5.60e-165 -1.47     -1.27     Neg_binomial    0.254     
##  5 Date         0.000225 0.00000237     94.9  0          0.000221  0.000230 Poisson         0.0225%   
##  6 Date         0.000225 0.00000294     76.7  0          0.000220  0.000231 Poisson_vcovHC  0.0225%   
##  7 Date         0.000225 0.00000443     50.9  0          0.000217  0.000234 Poisson_vcovHAC 0.0225%   
##  8 Date         0.000233 0.00000293     79.6  0          0.000227  0.000239 Neg_binomial    0.0233%   
##  9 Dst_mean    -0.000486 0.000316       -1.54 1.24e-  1 -0.00110   0.000134 Poisson         -0.0485%  
## 10 Dst_mean    -0.000486 0.000402       -1.21 2.27e-  1 -0.00127   0.000302 Poisson_vcovHC  -0.0485%  
## # ℹ 14 more rows
```

## Диагностика моделей

``` r
# Регрессия Пуассона
plot(model_poisson)
```

![](data/pics/models-plots-1.png)<!-- -->![](data/pics/models-plots-2.png)<!-- -->![](data/pics/models-plots-3.png)<!-- -->![](data/pics/models-plots-4.png)<!-- -->

``` r
crPlots(model_poisson)
```

![](data/pics/models-plots-5.png)<!-- -->

``` r
#  Отрицательное биномиальное распределение
plot(model_NBR)
```

![](data/pics/models-plots-6.png)<!-- -->![](data/pics/models-plots-7.png)<!-- -->![](data/pics/models-plots-8.png)<!-- -->![](data/pics/models-plots-9.png)<!-- -->

``` r
crPlots(model_NBR)
```

![](data/pics/models-plots-10.png)<!-- -->


## Сравнение моделей

``` r
bind_rows(Poisson_data, Poisson_vcovHC_data, Poisson_vcovHAC_data, Neg_binomial_data) %>% 
  filter(term != "(Intercept)") %>%
  ggplot(aes(x = term,y = estimate, ymin = conf.low, ymax = conf.high, colour = model))+
  geom_pointrange(position = position_dodge(width = 0.6)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") + 
  coord_flip() + 
  labs( x = "", y = "Оценка коэффициена", title = "Сравнение моделей") +
  theme_custom
```

![](data/pics/models-compare-1.png)<!-- -->


## Преобразование Dst

``` r
Dst_m1 <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var,
                     data = brain_data, family = poisson) 

Dst_m2 <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_PC1 + Dst_PC2,
                     data = brain_data, family = poisson) 

Dst_m3 <-glm(EMS ~ Date + Temp_mean + Sunspots + Dst_level,
                     data = brain_data, family = poisson) 

AIC(Dst_m1, Dst_m2, Dst_m3)
```

```
##        df      AIC
## Dst_m1  6 33271.26
## Dst_m2  6 33272.13
## Dst_m3  8 33271.85
```
## Преобразование Sunspot

``` r
Sunspots_m0 <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var, 
    data = brain_data, family = poisson) 

Sunspots_m1 <- glm(EMS ~ Date + Temp_mean + I(lag(Sunspots, 1)) + Dst_mean + Dst_var, 
    data = brain_data, family = poisson) 

Sunspots_m2 <- glm(EMS ~ Date + Temp_mean + I(lag(Sunspots, 2)) + Dst_mean + Dst_var, 
    data = brain_data, family = poisson) 

Sunspots_m3 <- glm(EMS ~ Date + Temp_mean + I(lag(Sunspots, 3)) + Dst_mean + Dst_var, 
    data = brain_data, family = poisson) 

Sunspots_mean <- glm(EMS ~ Date + Temp_mean + I(rollmean(Sunspots, 30, fill = NA)) + Dst_mean + Dst_var, 
    data = brain_data, family = poisson) 

acf(brain_data$Sunspots)
```

![](data/pics/models-Sunspot-1.png)<!-- -->

``` r
AIC(Sunspots_m0, Sunspots_m1, Sunspots_m2, Sunspots_m3, Sunspots_mean)
```

```
## Warning in AIC.default(Sunspots_m0, Sunspots_m1, Sunspots_m2, Sunspots_m3, : models are not all fitted to the
## same number of observations
```

```
##               df      AIC
## Sunspots_m0    6 33271.26
## Sunspots_m1    6 33266.95
## Sunspots_m2    6 33261.60
## Sunspots_m3    6 33258.04
## Sunspots_mean  6 33095.26
```


## Сезонная цикличность

``` r
brain_data %>%
  transmute(
    Date,
    cos_day = cospi(as.numeric(format(Date, "%j")) / 365)
  ) %>% ggplot()+
  geom_point(aes(Date, cos_day), colour = "skyblue")+
  theme_custom
```

![](data/pics/models-period-1.png)<!-- -->

``` r
Date_mo <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean +
                 Dst_var, data = brain_data, family = poisson)
Date_m1 <-glm(EMS ~ Date + I(cospi(as.numeric(format(Date, "%j")) / 365)) + Temp_mean + Sunspots + Dst_mean +
                Dst_var, data = brain_data, family = poisson)
Date_m2 <- glm(EMS ~ Date + Month + Temp_mean + Sunspots + Dst_mean +
                 Dst_var, data = brain_data, family = poisson) 
Date_m3 <-glm(EMS ~ Date + I(wday(Date, week_start = 1)) + Temp_mean + Sunspots + Dst_mean +
                Dst_var, data = brain_data, family = poisson)

anova(Date_mo, Date_m1, test = "LR")
```

```
## Analysis of Deviance Table
## 
## Model 1: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var
## Model 2: EMS ~ Date + I(cospi(as.numeric(format(Date, "%j"))/365)) + Temp_mean + 
##     Sunspots + Dst_mean + Dst_var
##   Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    
## 1      5731     8996.3                          
## 2      5730     8984.3  1   12.047 0.0005187 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

``` r
anova(Date_mo, Date_m2, test = "LR")
```

```
## Analysis of Deviance Table
## 
## Model 1: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var
## Model 2: EMS ~ Date + Month + Temp_mean + Sunspots + Dst_mean + Dst_var
##   Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    
## 1      5731     8996.3                          
## 2      5720     8954.0 11   42.301 1.437e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

``` r
anova(Date_mo, Date_m3, test = "LR")
```

```
## Analysis of Deviance Table
## 
## Model 1: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var
## Model 2: EMS ~ Date + I(wday(Date, week_start = 1)) + Temp_mean + Sunspots + 
##     Dst_mean + Dst_var
##   Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    
## 1      5731     8996.3                          
## 2      5730     8503.9  1   492.44 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

## Сезонная цикличность


``` r
Factor_mo <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean +
                 Dst_var, data = brain_data, family = poisson)
Factor_m1 <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean +
                 Dst_var + Sud_Imp, data = brain_data, family = poisson)
Factor_m2 <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean +
                 Dst_var + Sud_Storm, data = brain_data, family = poisson)
Factor_m3 <- glm(EMS ~ Date + Temp_mean + Sunspots + Dst_mean +
                 Dst_var + COVID, data = brain_data %>% 
                   mutate(COVID = ifelse(Date >= "2020-03-27", "Yes", "No")),
                 family = poisson)

anova(Factor_mo, Factor_m1, test = "LR")
```

```
## Analysis of Deviance Table
## 
## Model 1: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var
## Model 2: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var + Sud_Imp
##   Resid. Df Resid. Dev Df Deviance Pr(>Chi)
## 1      5731     8996.3                     
## 2      5730     8995.0  1   1.3197   0.2506
```

``` r
anova(Factor_mo, Factor_m2, test = "LR")
```

```
## Analysis of Deviance Table
## 
## Model 1: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var
## Model 2: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var + Sud_Storm
##   Resid. Df Resid. Dev Df  Deviance Pr(>Chi)
## 1      5731     8996.3                      
## 2      5730     8996.3  1 0.0001852   0.9891
```

``` r
anova(Factor_mo, Factor_m3, test = "LR")
```

```
## Analysis of Deviance Table
## 
## Model 1: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var
## Model 2: EMS ~ Date + Temp_mean + Sunspots + Dst_mean + Dst_var + COVID
##   Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    
## 1      5731     8996.3                          
## 2      5730     8261.4  1   734.98 < 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

