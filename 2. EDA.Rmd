---
title: "Разведочный анализ данных"
author: "Евгений Бердинских, Марина Козырева, Антон Тихоненко, Олеся Цветкова"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = "data/pics/EDA-"
  )

library(corrplot)
library(corrr)
library(conflicted)
library(forecast)
library(ggpubr)
library(tidyverse)
library(lubridate)
library(GGally)
library(ggfortify) 


conflict_prefer("filter", "dplyr", "stats")
conflict_prefer("lag", "dplyr", "stats")

theme_custom <- theme_bw()+ theme(
    plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 25, hjust = 0.5),
    strip.text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 25),
    legend.title = element_text(size = 25),
    legend.text = element_text(size = 20)
  )

```

## Загрузка данных для анализа

```{r read, message=FALSE}

brain_data <- read_csv("data/raw/brain_data.csv") %>%
   mutate(across(c(Month, Year, Dst_level, Sud_Imp, Sud_Storm, COVID), as.factor))

brain_data_long <- read_csv("data/raw/brain_data_long.csv") %>%
   mutate(across(c(Month, Year, Dst_level, Sud_Imp, Sud_Storm, Sex, Age, COVID), as.factor))

work_days <- read_csv("./data/raw/working_calendar_all_years.csv",
                      show_col_types = FALSE)

```

## Корреляция количественных переменных

```{r message = false fig.width=20}


# Предобработка данных
brain_data_clear <- brain_data %>% 
  select(where(is.numeric) & !c(ends_with("min"), ends_with("max")) & 
         !c("Date", "Month", "Year", "Dst_var", "Dst_level", "Dst_PC1", "Dst_PC2")) %>% filter(complete.cases(.))

# Функция для отображения корреляций с нейтральным цветом для значений близких к 0
color_correlation_fixed <- function(data, mapping, ...) {
  x <- eval_data_col(data, mapping$x)
  y <- eval_data_col(data, mapping$y)
  cor_value <- cor(x, y, use = "complete.obs")
  
  # Определение цвета: близкие к 0 делаем нейтральными (серым)
  color <- if (abs(cor_value) < 0.1) {
    scales::alpha("gray50", 0.5)  # Нейтральный серый для слабых корреляций
  } else if (cor_value > 0) {
    scales::alpha("blue", abs(cor_value))  # Синий для положительных
  } else {
    scales::alpha("red", abs(cor_value))   # Красный для отрицательных
  }
  
  # Фильтр для небольших значений корреляции
  cor_label <- ifelse(abs(cor_value) < 0.01, "0", sprintf("%.2f", cor_value))
  
  ggplot(data.frame()) + # Пустой data.frame
    annotate(
      "text", 
      x = 0.5, y = 0.5, # Центр ячейки
      label = cor_label,
      size = 6,
      color = color
    ) +
    theme_void() # Убираем лишнее оформление
}

# Функция для линии тренда с золотистым цветом
golden_smooth <- function(data, mapping, ...) {
  ggplot(data, mapping) +
    geom_point(alpha = 0.4, size = 0.5, color = "black") + # Прозрачные точки
    geom_smooth(color = "gold", ...) + # Золотистый цвет линии тренда
    
    theme_custom
}

# Построение графика
ggpairs(
  brain_data_clear, 
  progress = FALSE,
  upper = list(continuous = color_correlation_fixed), # Подсветка корреляций
  lower = list(continuous = golden_smooth)           # Золотистая линия тренда
)+
  theme(
    axis.text.x = element_text(size = 8),  # Уменьшение текста по оси X
    axis.text.y = element_text(size = 8)   # Уменьшение текста по оси Y
  )
```

```{r cor, fig.width=10, message=FALSE}

cor_data <- brain_data %>% 
  select( where(is.numeric) & !c(Temp_min, Temp_max, Dst_PC1, Dst_PC2) ) %>%
  cor(use = "pairwise.complete.obs") 
  
corrplot(cor_data, method = 'number', type = 'lower', diag = FALSE)

network_plot(cor_data, min_cor = .1)

```

При анализе сетевого графика можно выделить три группы признаков:

-   Климатические: температура, давление, ветер, осадки;
-   Геомагнитные: индексы Dst, Ap;
-   Солнечные: индекс F10.7, количество солнечных пятен.

При этом некоторые признаки внутри групп обладают высокой степенью корреляции!

```{r point, message=FALSE}

brain_data %>% 
  ggplot(aes(Sunspots, F10.7))+
  geom_jitter(alpha = 0.5, colour = "royalblue2", size = 1.5)+
  geom_smooth(method = "lm", se = FALSE, colour = "orangered2", linewidth = 1.2) +
  stat_cor(method = "pearson", label.x.npc = 0.4, label.y.npc = "top", size = 5)+
  theme_custom

brain_data %>% 
  ggplot(aes(Dst_mean, Ap_mean))+
  geom_jitter(alpha = 0.5, colour = "royalblue2", size = 1.5)+
  geom_smooth(method = "lm", se = FALSE, colour = "orangered2", linewidth = 1.2) +
  stat_cor(method = "pearson", label.x.npc = 0.4, label.y.npc = "top", size = 5)+
  theme_custom

brain_data %>% 
  drop_na() %>% 
  ggplot(aes(Temp_mean, Pressure))+
  geom_jitter(alpha = 0.5, colour = "royalblue2", size = 1.5)+
  geom_smooth(method = "lm", se = FALSE, colour = "orangered2", linewidth = 1.2) +
  stat_cor(method = "pearson", label.x.npc = 0.4, label.y.npc = "top", size = 5)+
  theme_custom

```

-   Индекс **F10.7** и количество **солнечных пятен** показывают высокую корреляцию (r = 0.92), поскольку оба показателя отражают солнечную активность, но измеряются разными методами.\
-   Среднесуточные индексы **Ap** и **Dst** также заметно коррелируют (r = -0.70), так как оба характеризуют изменения в геомагнитном поле Земли под воздействием солнечного ветра.\
-   Также ожидаемо выявлена отрицательная корреляция между средней температурой и давлением за день (r = -0.73).

Для дальнейшего анализа из каждой пары переменных оставим одну:\
1.
**Количество солнечных пятен** — этот показатель имеет полный набор данных и обладает большей вариативностью.\
2.
**Индекс Dst** — напрямую связан с влиянием солнечной активности на магнитосферу.\
3.
**Температура** — обеспечивает полный охват данных за весь период исследования и обладает более высокой вариативностью.

```{r cor2, fig.width=10, message=FALSE}

cor_data2 <- brain_data %>% 
  select( where(is.numeric) & !c(Temp_min, Temp_max, F10.7, Pressure, Ap_mean) ) %>%
  cor(use = "pairwise.complete.obs") 
  
corrplot(cor_data2, method = 'number', type = 'lower', diag = FALSE)

network_plot(cor_data2, min_cor = .1)

```

Влияние Dst_PC1 и Dst_PC2 на рост числа вызовов скорой помощи, вероятно, схоже с Dst_mean и Dst_var, но их стоит дополнительно проверить на этапе моделирования.

## Циклы солнечной активности

```{r cycle}

brain_data %>% 
  select(!c(Pressure, F10.7, Ap_mean)) %>% 
  ggplot(aes(Date, Sunspots))+
  geom_line(alpha = 0.3, colour = "royalblue2")+
  geom_smooth(method = "gam", formula = y ~ s(x, k = 10),  se = FALSE,
              colour = "orangered4", linewidth = 2) +
  geom_vline(xintercept = as.Date("2009-01-01"), 
             colour = "orangered", linewidth = 1, linetype = "dashed")+
  geom_vline(xintercept = as.Date("2019-12-31"), 
             colour = "orangered", linewidth = 1, linetype = "dashed")+
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")+
  theme_bw()

```

Количество солнечных пятен напрямую связано с циклами солнечной активности, что подтверждается на графике.
Для дальнейшего анализа целесообразно отдельно рассмотреть период 2009–2019 гг., охватывающий полный 24-й цикл солнечной активности

## Декомпозиция данных

```{r decompose, fig.height=8}

brain_data %>% 
  filter(Date >=  ymd("2007-01-01")) %>%
  pull(Sunspots) %>% ts(start = 2007, frequency = 365) %>%
  stl(s.window = "periodic") %>% 
  autoplot() + 
  theme_custom

```

Декомпозиция позволяет выявить тренды и сезонную цикличность:

```{r check, fig.width=12, message=FALSE, warning=FALSE}

##Линейный тренд EMS
brain_data %>% 
  filter(Date >=  ymd("2007-01-01")) %>%
  pull(EMS) %>% ts(start = 2007, frequency = 365) %>%
  stl(s.window = "periodic") %>% 
  .$time.series %>% .[,"trend"] %>%
  autoplot() + 
  scale_x_continuous(n.breaks = 10)+
  theme_custom+
  ggtitle("Декомпозиция вызовов скорой помощи: Тренд")


##Сезонная цикличность по температуре
brain_data %>% 
  filter(Date >=  ymd("2007-01-01")) %>%
  pull(Temp_mean) %>% ts(start = 2007, frequency = 365) %>%
  stl(s.window = "periodic") %>% 
  .$time.series %>% .[,"seasonal"] %>%
  autoplot()+
  scale_x_continuous(n.breaks = 10)+
  theme_custom+
  ggtitle("Декомпозиция температуры: Сезонность")


# Сложности с индексом Dst
ggarrange(
brain_data %>% 
  filter(Date >=  ymd("2007-01-01")) %>%
  pull(Sunspots) %>% ts(start = 2007, frequency = 365) %>%
  stl(s.window = "periodic") %>% 
  .$time.series %>% .[,"trend"] %>%
  autoplot() + 
  scale_x_continuous(n.breaks = 5)+
  theme_custom, 
  
brain_data %>% 
  filter(Date >=  ymd("2007-01-01")) %>%
  pull(Dst_var) %>% ts(start = 2007, frequency = 365) %>%
  stl(s.window = "periodic") %>% 
  .$time.series %>% .[,"trend"] %>%
  autoplot() + 
  scale_x_continuous(n.breaks = 5)+
  theme_custom, 

 labels = c("Декомпозиция солнечных пятен: Тренд", "Декомпозиция индекса Dst: Тренд") 
  ) 


```

-   После декомпозиции данных о вызовах скорой помощи наблюдается линейный рост во времени. Однако начиная с 2020 года заметно снижение, которое, вероятно, связано с пандемией COVID-19.
-   Климатические данные (особенно температура), после декомпозиции, демонстрируют выраженную цикличность.
-   Индекс Dst_mean не показывает явных трендов или циклов. В то время как индекс Dst_var (амплитуда колебаний индекса Dst за день), после декомпозиции, имеет тренд, схожий с динамикой количества солнечных пятен.

## Визуализация ассоциаций

```{r vis, fig.width=15}

#EMS/Sunspots сезонность
ggarrange(
brain_data %>%  
  filter(Date %within% interval(ymd("2007-01-01"), ymd("2019-12-31"))) %>%
  group_by(Year, Month) %>% 
  summarise(EMS_month = sum(EMS, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(x = Month, y = Year, fill = EMS_month)) +
  geom_tile(colour = "black") + 
  scale_fill_gradient(low = "green", high = "red") + 
  scale_y_discrete(expand = expansion(add = c(0, 2)))+
  labs(x = "", y  = "", fill = "")+
  theme_custom,

brain_data %>%  
  filter(Date %within% interval(ymd("2007-01-01"), ymd("2019-12-31"))) %>%
  group_by(Year, Month) %>% 
  summarise(Sunspots_month = sum(Sunspots, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(x = Month, y = Year, fill = Sunspots_month)) +
  geom_tile(colour = "black") + 
  scale_fill_gradient(low = "green", high = "red") + 
  scale_y_discrete(expand = expansion(add = c(0, 2)))+
  labs(x = "", y  = "", fill = "")+
  theme_custom, 
 
labels = c("Суммарное количество вызовов скорой", "Суммарное количество солнечных пятен")
)

#Dst ~ Sunspots
brain_data %>%
  filter(Dst_level != "Severe") %>%
  ggplot(aes(Dst_level, Sunspots))+
  geom_jitter(alpha = 0.5)+
  geom_boxplot(alpha = 0.5, outliers = FALSE, fill = "goldenrod2", linewidth = 1)+
  theme_custom

```

## Рабочие дни и сезоны ~ EMS

### Тип дня 

```{r}

brain_data_work <- work_days %>%
  rename(DayType = Type) %>%  # Переименование столбца Type в DayType
  inner_join(brain_data, by = "Date") %>%
  mutate(DayType = as.factor(DayType),
         DayType = dplyr::recode(DayType, "work" = "workday", "nowork" = "weekend")) 
skimr::skim(brain_data_work)
```

```{r, fig.width=12}
# Устанавливаем цвета для каждого DayType
daytype_colors <- c(
  "holiday weekend" = "green3",  
  "weekend" = "darkgreen",         
  "preholiday" = "steelblue",    
  "workday" = "firebrick"        
)

# Построение боксплота 
ggplot(brain_data_work, aes(x = DayType, y = EMS, fill = DayType)) +
  geom_boxplot() +
  scale_fill_manual(values = daytype_colors) +
  labs(
    title = "EMS в зависимости от DayType",
    x = "Тип дня (DayType)",
    y = "EMS",
    fill = "Тип дня"
  ) +
  theme_custom 
  
```
```{r}

merged_data <- brain_data_work %>%
  filter(DayType %in% c("workday", "weekend")) # Оставляем только интересующие уровни
 
# Проверяем уровни переменной DayType
levels(merged_data$DayType)

# Выполняем t-тест
t_test_result <- t.test(
  EMS ~ DayType, 
  data = merged_data %>% filter(!is.na(EMS))
)
print(t_test_result)


```

**Интерпретация:**
- \( p \)-value < 0.05: Различие между средними значениями EMS для будней и выходных **статистически значимо**.
- Среднее значение EMS выше на будних днях (14.94728) по сравнению с выходными (12.58244).


### Сезоны
```{r fig.width=12}

# Добавляем колонку с сезоном
brain_data_season <- brain_data_work %>%
  mutate(
    Season = case_when(
      Month %in% c(12, 1, 2) ~ "Winter",
      Month %in% c(3, 4, 5) ~ "Spring",
      Month %in% c(6, 7, 8) ~ "Summer",
      Month %in% c(9, 10, 11) ~ "Autumn",
      TRUE ~ NA_character_
    ),
    Season = as.factor(Season)  # Преобразуем в фактор
  )

# Проверяем распределение EMS по сезонам
ggplot(brain_data_season, aes(x = Season, y = EMS, fill = Season)) +
  geom_boxplot(alpha = 0.7) +
  theme_custom +
  labs(title = "Распределение EMS по сезонам", x = "Сезон", y = "EMS")


# Сравнение EMS между сезонами: тест Крускала–Уоллиса
kruskal_test <- kruskal.test(EMS ~ Season, data = brain_data_season)
print("Крускала–Уоллиса тест:")
print(kruskal_test)


# попарное сравнение (Dunn test)
if (kruskal_test$p.value < 0.05) {
  pairwise_comparison <- FSA::dunnTest(EMS ~ Season, data = brain_data_season, method = "bonferroni")
  print("Попарное сравнение (Dunn test):")
  print(pairwise_comparison)
}

```

**Выводы**
1. Распределение EMS между сезонами различается (p-value Крускала-Уоллиса < 0.05).
2. При попарном сравнении значимые различия найдены только между **Autumn** и **Winter** (p.adj = 0.033).
3. Для других пар сезонов различия статистически незначимы.



